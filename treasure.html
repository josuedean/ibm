<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <!-- Ensures proper scaling on mobile -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>3D ASCII Chalice (Mobile Touch-Friendly)</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Tangerine:wght@700&display=swap">
  <style>
    /* Make sure the page and container occupy the full screen
       and prevent default overflow behaviors on mobile. */
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden; 
      background-color: #000;
      color: #fff;
      font-family: monospace;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
    }

    .title {
      font-family: 'Tangerine', cursive;
      font-size: 32px;
      color: gold;
      text-align: center;
      margin: 20px 0;
      text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
      max-width: 80%;
      z-index: 10;
    }

    /* This container holds the ASCII output. "touch-action: none"
       is critical on mobile so pinch/drag events go to OrbitControls. */
    #ascii-display {
      white-space: pre;
      line-height: 0.9;
      font-size: 10px;
      letter-spacing: -0.5px;
      touch-action: none;     /* Prevent default browser gestures */
      user-select: none;      /* Disables text selection highlight on touch */
      -webkit-user-select: none;
      -ms-user-select: none;
      flex: 1; /* Let it fill remaining space */
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>
<body>
  <div class="title">
    An intricately rendered chalice made entirely of ASCII characters, awarded to true text-command masters.
  </div>
  <div id="ascii-display"></div>

  <script src="https://unpkg.com/three@0.128.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://unpkg.com/three@0.128.0/examples/js/effects/AsciiEffect.js"></script>
  <script>
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x000000);

    const camera = new THREE.PerspectiveCamera(
      60,
      window.innerWidth / window.innerHeight,
      0.1,
      1000
    );
    camera.position.set(0, 2.5, 5);
    camera.lookAt(0, 1, 0);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);

    // Lights
    const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
    scene.add(ambientLight);

    const frontLight = new THREE.DirectionalLight(0xffffff, 1.2);
    frontLight.position.set(5, 5, 5);
    scene.add(frontLight);

    const backLight = new THREE.DirectionalLight(0xffffff, 0.5);
    backLight.position.set(-5, 3, -5);
    scene.add(backLight);

    const sideLight = new THREE.DirectionalLight(0xffffff, 0.4);
    sideLight.position.set(5, 0, -5);
    scene.add(sideLight);

    // Chalice Group
    const chaliceGroup = new THREE.Group();
    scene.add(chaliceGroup);

    // Main chalice profile
    const points = [];
    points.push(new THREE.Vector2(0.05, 0.0));
    points.push(new THREE.Vector2(1.0, 0.0));
    points.push(new THREE.Vector2(0.9, 0.05));
    points.push(new THREE.Vector2(0.8, 0.1));
    points.push(new THREE.Vector2(0.9, 0.2));
    points.push(new THREE.Vector2(0.5, 0.3));
    points.push(new THREE.Vector2(0.4, 0.6));
    points.push(new THREE.Vector2(0.5, 0.9));
    points.push(new THREE.Vector2(0.7, 1.1));
    points.push(new THREE.Vector2(0.9, 1.3));
    points.push(new THREE.Vector2(1.0, 1.5));
    points.push(new THREE.Vector2(1.1, 1.7));
    points.push(new THREE.Vector2(1.2, 1.75));
    points.push(new THREE.Vector2(1.1, 1.8));
    points.push(new THREE.Vector2(1.2, 1.85));
    points.push(new THREE.Vector2(1.1, 1.9));
    points.push(new THREE.Vector2(1.2, 1.95));
    points.push(new THREE.Vector2(1.0, 2.0));

    const geometry = new THREE.LatheGeometry(points, 192);
    const material = new THREE.MeshPhongMaterial({
      color: 0xffd700,
      shininess: 120,
      specular: 0xffffdd,
      side: THREE.DoubleSide
    });

    const chalice = new THREE.Mesh(geometry, material);
    chalice.scale.set(1.5, 1.5, 1.5);
    chaliceGroup.add(chalice);

    // Handles
    const handleWidth = 0.15;
    const handleShape = new THREE.Shape();
    handleShape.ellipse(0, 0, handleWidth, handleWidth, 0, Math.PI * 2);

    // Left handle
    const leftHandleCurve = new THREE.CubicBezierCurve3(
      new THREE.Vector3(-0.6, 0.7, 0),
      new THREE.Vector3(-1.4, 0.9, 0),
      new THREE.Vector3(-1.4, 1.4, 0),
      new THREE.Vector3(-0.9, 1.5, 0)
    );

    const leftExtrudeSettings = {
      steps: 40,
      bevelEnabled: false,
      extrudePath: leftHandleCurve
    };
    const leftHandleGeometry = new THREE.ExtrudeGeometry(handleShape, leftExtrudeSettings);
    const leftHandle = new THREE.Mesh(leftHandleGeometry, material);
    leftHandle.scale.set(1.5, 1.5, 1.5);
    chaliceGroup.add(leftHandle);

    // Right handle
    const rightHandleCurve = new THREE.CubicBezierCurve3(
      new THREE.Vector3(0.6, 0.7, 0),
      new THREE.Vector3(1.4, 0.9, 0),
      new THREE.Vector3(1.4, 1.4, 0),
      new THREE.Vector3(0.9, 1.5, 0)
    );

    const rightExtrudeSettings = {
      steps: 40,
      bevelEnabled: false,
      extrudePath: rightHandleCurve
    };
    const rightHandleGeometry = new THREE.ExtrudeGeometry(handleShape, rightExtrudeSettings);
    const rightHandle = new THREE.Mesh(rightHandleGeometry, material);
    rightHandle.scale.set(1.5, 1.5, 1.5);
    chaliceGroup.add(rightHandle);

    // Slight tilt
    chaliceGroup.rotation.z = Math.PI * 0.05;
    chaliceGroup.rotation.x = Math.PI * 0.15;

    // ASCII effect
    const ascii = new THREE.AsciiEffect(
      renderer,
      ' .,:;i1tfLCG08@',
      { invert: true, resolution: 0.1 }
    );
    ascii.setSize(window.innerWidth, window.innerHeight);

    // Attach to the #ascii-display container
    const asciiContainer = document.getElementById('ascii-display');
    asciiContainer.appendChild(ascii.domElement);

    // OrbitControls with explicit touch settings
    const controls = new THREE.OrbitControls(camera, ascii.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.1;

    // Disable auto-rotate to let users rotate with a single finger
    controls.autoRotate = false;
    controls.autoRotateSpeed = 1.0;

    // Pinch-to-zoom, rotate with one finger
    controls.enableZoom = true;
    controls.enableRotate = true;
    controls.enablePan = false;  // Turn off panning if you like

    // Touch configuration for better mobile gestures
    controls.touches = {
      ONE: THREE.TOUCH.ROTATE,    // Single-finger move = rotate
      TWO: THREE.TOUCH.DOLLY_PAN  // Two-fingers = pinch (zoom) or move both fingers (pan)
    };

    // Set desired distance range
    controls.minDistance = 1;
    controls.maxDistance = 20;

    // Resize handling
    window.addEventListener('resize', () => {
      const width = window.innerWidth;
      const height = window.innerHeight;
      camera.aspect = width / height;
      camera.updateProjectionMatrix();
      renderer.setSize(width, height);
      ascii.setSize(width, height);
    });

    // Animation
    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      ascii.render(scene, camera);
    }
    animate();
  </script>
</body>
</html>
